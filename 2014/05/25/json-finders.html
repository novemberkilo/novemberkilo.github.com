<!DOCTYPE html>
<html lang='en'></html>
<head>
  <meta charset='utf-8'>
  <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
  <title></title>
  <meta content='' name='description'>
  <meta content='' name='author'>
  <meta content='width=device-width, initial-scale=1.0' name='viewport'>
  <link href="/stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
  <div class='container'>
    <div class='navbar navbar-fixed-top'>
      <div class='navbar-inner'>
        <div class='container'>
          <a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
            <span class='icon-bar'></span>
          </a>
          <a class='brand' href='http://novemberkilo.com'>The iNK blot</a>
          <div class='nav-collapse collapse'>
            <ul class='nav'>
              <li>
                <a href="/">Home</a>
              </li>
              <li>
                <a href="/about.html">About</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class='span8 offset2'>
      <article>
        <h2>Postgres JSON Functions From Rails</h2>
        <h4></h4>
        <div class='pull-right'>
          <time>May 25 2014</time>
        </div>
        <br>
        <p>Say you are storing JSON in Postgres and need scopes to get records
        based on their JSON attributes. This post covers the use of JSON functions
        available in Postgres v9.3 to achieve this.</p>
        
        <p>Suppose you have an Order class, containing a JSON blob that describes
        the product that the order relates to:</p>
        
        <pre><code># == Schema Information&#x000A;#&#x000A;# Table name: orders&#x000A;#&#x000A;#  id                                    :integer  not null, primary key&#x000A;#  customer_id                           :integer&#x000A;#  product                               :json&#x000A;#  created_at                            :datetime&#x000A;#  updated_at                            :datetime&#x000A;&#x000A;class Order &lt; ActiveRecord::Base&#x000A;&#x000A;end&#x000A;</code></pre>
        
        <p>Suppose <code>product</code> has the following structure:</p>
        
        <pre><code>{ &quot;name&quot;: &quot;Widget 01&quot;,&#x000A;  &quot;code&quot;: &quot;W001&quot;,&#x000A;  &quot;plan&quot;: {&#x000A;            &quot;name&quot;: &quot;Silver&quot;,&#x000A;            &quot;terms&quot;: &quot;12 months&quot;&#x000A;          },&#x000A;  &quot;created_at&quot;: &quot;2013-12-22 09:27:45 UTC&quot;,&#x000A;  &quot;updated_at&quot;: &quot;2014-10-21 10:30:40 UTC&quot;&#x000A;}&#x000A;</code></pre>
        
        <p>And you want a scope on <code>Order</code> to find all orders with a particular
        code - something like <code>Order.with_code(&quot;W001&quot;)</code></p>
        
        <p>If you are using version 9.3 of Postgres, you can get it to do the heavy
        lifting for you using its <a href="http://www.postgresql.org/docs/9.3/static/functions-json.html">JSON functions</a>
        like so:</p>
        
        <pre><code>scope :with_code, -&gt;(code) { where(&quot;product -&gt;&gt; &#39;code&#39; = ?&quot;, code) }&#x000A;</code></pre>
        
        <p>Getting to nested JSON attributes is a bit trickier. Say you want a
        scope for all orders with a particular plan name - something like
        <code>Order.with_plan_name(&quot;Silver&quot;)</code></p>
        
        <pre><code>scope :with_plan_name, -&gt;(plan_name) { where(&quot;product::json #&gt;&gt; &#39;{ plan,name }&#39; = ?&quot;, plan_name) }&#x000A;</code></pre>
        
        <p>I got to these by looking through Stack Overflow posts, grokking the Postgres
        docs on JSON functions and <a href="http://devblog.avdi.org/2014/01/31/playing-with-json-in-postgres/">this post</a>
        of Avdi Grimm&#39;s. As usual, you can&#39;t comment here but if you see an error or
        want to offer a suggestion for improvement, please get in touch via email.</p>
      </article>
      <footer>
        <div id='contacts'>
          <a href="http://twitter.com/novemberkilo">Twitter</a>
           |
          <a href="https://github.com/novemberkilo">Github</a>
           |
          <a href="/feed.xml">RSS</a>
        </div>
        <div id='license'>
          <small class='pull-right'>
            Licensed under
            <a href="http://creativecommons.org/licenses/by/3.0/">CC by 3.0</a>
          </small>
        </div>
      </footer>
    </div>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
  <script>
    window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.8.3.min.js"><\/script>')
  </script>
  <script src="/javascripts/plugins.js" type="text/javascript"></script>
  <script src="/javascripts/script.js" type="text/javascript"></script>
  <script src="/javascripts/bootstrap.js" type="text/javascript"></script>
  <link rel="stylesheet" href="http://yandex.st/highlightjs/8.0/styles/tomorrow-night.min.css">
  <script src="http://yandex.st/highlightjs/8.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>
    var _gaq=[['_setAccount','UA-16831355-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
