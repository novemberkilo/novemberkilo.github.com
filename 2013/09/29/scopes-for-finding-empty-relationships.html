<!DOCTYPE html>
<html lang='en'></html>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<title></title>
<meta content='' name='description'>
<meta content='' name='author'>
<meta content='width=device-width, initial-scale=1.0' name='viewport'>
<link href="/stylesheets/screen.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
<div class='container'>
<div class='navbar navbar-fixed-top'>
<div class='navbar-inner'>
<div class='container'>
<a class='btn btn-navbar' data-target='.nav-collapse' data-toggle='collapse'>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
<span class='icon-bar'></span>
</a>
<a class='brand' href='http://novemberkilo.com'>The iNK blot</a>
<div class='nav-collapse collapse'>
<ul class='nav'>
<li>
<a href="/">Home</a>
</li>
<li>
<a href="/about.html">About</a>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class='span8 offset2'>
<article>
<h2>Handy scopes for checking associations</h2>
<h4></h4>
<div class='pull-right'>
<time>Sep 29 2013</time>
</div>
<br>
<p>If your Rails project has a has-many association and you want a way of finding records that have no associated records, or,
records that have at least one associated record, you might find this post useful.</p>

<p>Suppose you have classes <code>Person</code> and <code>Friend</code> that are associated via a <code>has_many</code> relationship:</p>

<pre><code>class Person &lt; ActiveRecord::Base&#x000A;  has_many :friends&#x000A;end&#x000A;&#x000A;class Friend &lt; ActiveRecord::Base&#x000A;  belongs_to :person&#x000A;end&#x000A;</code></pre>

<p>How do you find <code>persons</code> that have no <code>friends</code>?</p>

<pre><code>Person.includes(:friends).where("friends.person_id IS NULL")&#x000A;</code></pre>

<p>Or that have at least one <code>friend</code></p>

<pre><code>Person.includes(:friends).where("friends.person_id IS NOT NULL")&#x000A;</code></pre>

<h4 id="using-arel">Using Arel</h4>

<p>To accomplish this with Arel 
set up the following scopes on <code>Friend</code> (thanks to <a href="http://twitter.com/macfanatic">@macfanatic</a> for the tip),</p>

<pre><code>class Friend&#x000A;  belongs_to :person&#x000A;&#x000A;  scope :to_somebody, -&gt;{ where arel_table[:person_id].not_eq(nil) }&#x000A;  scope :to_nobody,   -&gt;{ where arel_table[:person_id].eq(nil) }&#x000A;end&#x000A;</code></pre>

<p>And then, Persons who have at least one friend:</p>

<pre><code>Person.includes(:friends).merge(Friend.to_somebody)&#x000A;</code></pre>

<p>The friendless:</p>

<pre><code>Person.includes(:friends).merge(Friend.to_nobody)&#x000A;</code></pre>

<p><em>Note:</em> If you are on Rails 4 donâ€™t forget to append <code>references(:friends)</code> to these.</p>


</article>
<footer>
<div id='contacts'>
<a href="http://twitter.com/novemberkilo">Twitter</a>
 | 
<a href="https://github.com/novemberkilo">Github</a>
 | 
<a href="/feed.xml">RSS</a>
</div>
<div id='license'>
<small class='pull-right'>
Licensed under
<a href="http://creativecommons.org/licenses/by/3.0/">CC by 3.0</a>
</small>
</div>
</footer>
</div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
<script>
  window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.8.3.min.js"><\/script>')
</script>
<script src="/javascripts/plugins.js" type="text/javascript"></script>
<script src="/javascripts/script.js" type="text/javascript"></script>
<script src="/javascripts/bootstrap.js" type="text/javascript"></script>
<script src="/javascripts/highlight.pack.js" type="text/javascript"></script>
<link href="/stylesheets/solarized_light.css" media="screen" rel="stylesheet" type="text/css" />
<script>hljs.initHighlightingOnLoad();</script>
<script>
  var _gaq=[['_setAccount','UA-16831355-1'],['_trackPageview']];
  (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
  g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
  s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
</body>
